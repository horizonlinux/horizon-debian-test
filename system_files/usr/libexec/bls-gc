#!/bin/bash

set -e
set -o pipefail

# Error logging function
log_error() {
    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        echo "ERROR: bls-gc script failed with exit code $exit_code at line $1" | logger -t bls-gc -p user.error
        echo "ERROR: bls-gc script failed with exit code $exit_code at line $1" >&2
    fi
}

# Set up error trap
trap 'log_error $LINENO' ERR

# This script removes unused kernels from the /boot/EFI/Linux directory
# using the Boot Loader Specification (BLS) entries found in /boot/loader/entries.
# TODO: remove this when bootc fixes issue https://github.com/bootc-dev/bootc/issues/1808
BLS_DIR="/boot/loader/entries"
BOOT_DIR="/boot/EFI/Linux"
if [ ! -d "$BLS_DIR" ] || [ ! -d "$BOOT_DIR" ]; then
    echo "BLS directory or Boot directory does not exist."
    exit 1
fi
# Collect all used kernel versions from BLS entries
# the boot configuration file has this line:
# linux /EFI/Linux/5a8097188a7d98e9d85f23d8a6003fe352182e65a7eb57ef9707c56686f7cfefcdba1fff7813be1badc2bd2454e4ebf67e9521f5537e5ce36da702a033971479/vmlinuz
# ignore the last part (the vmlinuz) and get the long hash-like string
used_kernels=()
for entry in "$BLS_DIR"/*.conf; do
    if [ -f "$entry" ]; then
        kernel_path=$(grep -E '^linux ' "$entry" | awk '{print $2}')
        if [[ $kernel_path =~ /EFI/Linux/([^/]+)/vmlinuz ]]; then
            kernel_version="${BASH_REMATCH[1]}"
            # Validate kernel_version: non-empty and 64 hex chars
            if [[ -n "$kernel_version" && "$kernel_version" =~ ^[a-fA-F0-9]{64}$ ]]; then
                echo "Found used kernel: $kernel_version"
                used_kernels+=("$kernel_version")
            else
                echo "WARNING: Ignoring invalid kernel version '$kernel_version' from entry '$entry'" >&2
            fi
        fi
    fi
done

# Remove unused kernels from the Boot directory
for kernel_file in "$BOOT_DIR"/*; do
    kernel_name=$(basename "$kernel_file")
    if [[ ! " ${used_kernels[*]} " =~  ${kernel_name}  ]]; then
        echo "Found and removing unused kernel: $kernel_name"
        rm -rf "$kernel_file"
    fi
done
echo "Cleanup complete."
