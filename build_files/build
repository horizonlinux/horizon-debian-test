#!/bin/bash

set -ouex pipefail

# Required packages
apt install -y \
  btrfs-progs \
  ca-certificates \
  curl \
  dracut \
  dosfstools \
  e2fsprogs \
  fdisk \
  firmware-linux-free \
  iproute2 \
  iputils-ping \
  lvm2 \
  linux-image-generic \
  network-manager \
  skopeo \
  sudo-rs \
  tpm2-tools \
  xfsprogs \
  zstd \
  cryptsetup \
  libfido2-1 \
  libfido2-dev \
  libtss2-esys-3.0.2-0 \
  libp11-kit0

# TODO: install the latest release by querying releases or using repo when appropriate
curl --fail --retry 5 --retry-all-errors -sSL -o /tmp/nbc.deb \
    https://github.com/frostyard/nbc/releases/download/dev/nbc_1.0.0.dev_amd64.deb
apt install -y /tmp/nbc.deb

# Use proper home directory for new users
sed -i 's|.*HOME=/home|HOME=/var/home|' "/etc/default/useradd"

# Enable mounts
systemctl enable home.mount
systemctl enable root.mount
systemctl enable srv.mount
systemctl enable mnt.mount
systemctl enable media.mount
systemctl enable opt.mount

# Fix permissions on sudoers.d
chmod 440 /etc/sudoers.d/001-bootc

# Add build information to os-release
echo "BUILD_ID=\"$BUILD_ID\"" >> /usr/lib/os-release

apt-mark hold plasma-discover
apt-mark hold plasma-theme-oxygen
apt install -y  \
  plasma-workspace \
  plasma-desktop \
  dolphin \
  konsole \
  flatpak \
  kde-config-flatpak \
  kwrite \
  git

apt install -y \
  build-essential \
  cmake \
  cmake-extras \
  extra-cmake-modules \
  pkgconf \
  gettext \
  qt6-base-dev \
  qt6-declarative-dev \
  qt6-svg-dev \
  libkf6auth-data libkf6auth-dev libkf6auth-dev-bin libkf6auth-doc libkf6authcore6 \
  libkf6coreaddons-data libkf6coreaddons-dev libkf6coreaddons-doc libkf6coreaddons6 qml6-module-org-kde-coreaddons \
  libkf6i18n-data libkf6i18n-dev libkf6i18n-doc libkf6i18n6 libkf6i18nlocaledata6 libkf6i18nqml6 qml6-module-org-kde-i18n-localedata \
  kpackagetool6 libkf6package-data libkf6package-dev libkf6package-doc libkf6package6 \
  libkf6config-bin libkf6config-data libkf6config-dev libkf6config-dev-bin libkf6config-doc libkf6configcore6 libkf6configgui6 libkf6configqml6 qml6-module-org-kde-config \
  libkf6configwidgets-data libkf6configwidgets-dev libkf6configwidgets-doc libkf6configwidgets6 \
  kscreen \
  libkf6screen8 libkf6screendpms8 libkscreen-bin libkscreen-data libkscreen-dev libkscreen-doc \
  libkf6windowsystem-data libkf6windowsystem-dev libkf6windowsystem-doc libkf6windowsystem6 qml6-module-org-kde-kwindowsystem

git clone https://invent.kde.org/plasma/plasma-setup /tmp/kiss
cd /tmp/kiss
cmake -B build \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr
cmake --build build
cmake --install build
install -Dm644 LICENSES/BSD-2-Clause.txt /usr/share/licenses/plasma-setup/LICENSE"

apt autoremove -y \
  build-essential \
  cmake \
  cmake-extras \
  extra-cmake-modules \
  pkgconf \
  gettext \
  qt6-base-dev \
  qt6-declarative-dev \
  qt6-svg-dev \
  libkf6auth-dev libkf6auth-dev-bin \
  libkf6coreaddons-dev \
  libkf6i18n-dev \
  libkf6package-dev \
  libkf6config-dev libkf6config-dev-bin \
  libkf6configwidgets-dev \
  libkscreen-dev \
  libkf6windowsystem-dev

systemd-sysusers
systemctl enable sddm
systemctl enable plasma-setup
systemctl disable systemd-firstboot
